let timer,emailFields={},firstNameFields={},lastNameFields={},fullNameFields={},outputData={url:"",at_key:document.currentScript.getAttribute("atKey"),email:"",first_name:"",last_name:"",full_name:"",ip_address:"",utm_source:"",utm_medium:"",utm_campaign:"",utm_term:"",utm_content:""},postCount=0,childListenerCount=0,parentListenerCount=0,docBody=document.body||document.documentElement;const observer=new MutationObserver(()=>{docBody?(timer&&clearTimeout(timer),timer=setTimeout(()=>{selfInquiry()},500)):window.setTimeout(observer,500)});observer.observe(docBody,{subtree:!0,childList:!0});let oldHref=document.location.href;function selfInquiry(){window.self==window.top?(findParams(),0===document.querySelectorAll('iframe[src*="clickfunnels"]').length?(console.log("We are the outer - simple"),findFields()):(console.log("We are the outer WITH an inner"),setParentListener())):(console.log("We are the INNER"),setChildListener(),findFields())}window.onload=(()=>{let e=document.querySelector("body");new MutationObserver(e=>{e.forEach(()=>{oldHref!=document.location.href&&(oldHref=document.location.href,selfInquiry())})}).observe(e,{childList:!0,subtree:!0})}),selfInquiry();let outputDataWatch={set:function(e,t,a){e[t]=a,t.includes("email")&&validateEmail(a)&&postData("https://adtorch.co/api/collect",e).then(e=>{postCount++,console.log(postCount)}).catch(e=>{console.log(e)})}},outputDataProxy=new Proxy(outputData,outputDataWatch);function findFields(e){!(!e||!e.reset)&&e.reset;emailFields=document.querySelectorAll("input[id*='email'], input[type*='email'], input[name*='email']"),firstNameFields=document.querySelectorAll("input[name*='first_name'], input[name*='firstName'], input[name*='firstname'], input[id*='first_name'], input[id*='firstName'], input[id*='firstname']"),lastNameFields=document.querySelectorAll("input[name*='last_name'], input[name*='lastName'], input[name*='lastname'], input[id*='last_name'], input[id*='lastName'], input[id*='lastname']"),fullNameFields=document.querySelectorAll("input[name*='full_name'], input[name*='fullName'], input[name*='fullname'], input[id*='full_name'], input[id*='fullName'], input[id*='fullname']"),emailFields.forEach(e=>{localStorage.setItem("adTorch_email",e.value);var t=e.form;t&&("true"!==t.getAttribute("atSubmitAdded")&&(t.setAttribute("atSubmitAdded","true"),t.addEventListener("submit",()=>{console.log("We've got one with a parent listener"),grabAndDispatch()})),t.onsubmit=(e=>{console.log("We've got one with a parent onSubmit"),grabAndDispatch()}))})}function grabAndDispatch(){0===postCount&&(postCount++,firstNameFields.forEach(e=>{""!=e.value&&(outputData.first_name=e.value)}),lastNameFields.forEach(e=>{""!=e.value&&(outputData.last_name=e.value)}),fullNameFields.forEach(e=>{""!=e.value&&(outputData.full_name=e.value)}),emailFields.forEach(e=>{""!=e.value&&(outputData.email=e.value)}),postData("https://adtorch.co/api/collect",outputData).then(e=>{console.log(postCount)}).catch(e=>{console.log(e)}))}function findParams(e){let t=!(!e||!e.reset)&&e.reset,a=window.location.href.toString().split("?");if(outputData.url=a[0],sessionStorage.setItem("url",decodeURIComponent(a[0])),localStorage.setItem("url",decodeURIComponent(a[0])),a.length>1){let e=a[1].split("&");for(let a in e){let o=e[a].split("=");outputData[o[0]]=o[1],(t||null===sessionStorage.getItem(o[0]))&&sessionStorage.setItem("adTorch_"+o[0],decodeURIComponent(o[1]))}}}function setParentListener(){window.addEventListener("message",e=>{"adTorch listener Ready"===e.data&&e.source.postMessage(outputData,"*")},!1)}function setChildListener(){0===childListenerCount&&(window.addEventListener("message",e=>{console.log(e.data),outputData=e.data}),childListenerCount++,setTimeout(()=>{window.parent.postMessage("adTorch listener Ready","*")}),console.log("Reported as ready. Listener count: ",childListenerCount))}function validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}async function postData(e,t){return await fetch(e,{method:"POST",keepalive:!0,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)})}findParams();
